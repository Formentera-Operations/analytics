name: Validate dbt changes

on:
  workflow_dispatch:
  pull_request:
    paths:
      - .github/workflows/validate-dbt-changes.yaml
      - macros/**
      - models/**
      - seeds/**
      - snapshots/**
      - dbt_project.yml
      - packages.yml

env:
  DBT_PROFILES_DIR: integration_tests/
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
  # PROD profile env vars
  SNOWFLAKE_PROD_USER: ${{ vars.SNOWFLAKE_PROD_USER }}
  SNOWFLAKE_PROD_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PROD_PRIVATE_KEY }}
  SNOWFLAKE_PROD_DATABASE: ${{ vars.SNOWFLAKE_PROD_DATABASE }}
  SNOWFLAKE_PROD_SCHEMA: ${{ vars.SNOWFLAKE_PROD_SCHEMA }}
  SNOWFLAKE_PROD_ROLE: ${{ vars.SNOWFLAKE_PROD_ROLE }}
  SNOWFLAKE_PROD_WAREHOUSE: ${{ vars.SNOWFLAKE_PROD_WAREHOUSE }}
  # CI profile env vars
  SNOWFLAKE_CI_USER: ${{ vars.SNOWFLAKE_CI_USER }}
  SNOWFLAKE_CI_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_CI_PRIVATE_KEY }}
  SNOWFLAKE_CI_DATABASE: ${{ vars.SNOWFLAKE_CI_DATABASE }}
  SNOWFLAKE_CI_SCHEMA: DBT_CI_${{ github.event.number }}  # Create a unique schema for each PR
  SNOWFLAKE_CI_ROLE: ${{ vars.SNOWFLAKE_CI_ROLE }}
  SNOWFLAKE_CI_WAREHOUSE: ${{ vars.SNOWFLAKE_CI_WAREHOUSE }}

jobs:
  validate-dbt-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
      - name: Set up Python
        uses: actions/setup-python@v6
        with: {python-version: "3.11"}
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          dbt deps --profile integration_tests --target ci

      # Validate project configuration
      - name: Validate dbt project
        run: >
          dbt parse
          --warn-error
          --profile integration_tests
          --target ci
      - name: Store dbt packages
        uses: actions/upload-artifact@v4
        with: &dbt-packages
          name: dbt_packages
          path: dbt_packages/
      - name: Store development artifacts
        uses: actions/upload-artifact@v4
        with: &dev-artifacts
          name: target
          path: target/

      # Generate production artifacts
      - name: Checkout main branch
        uses: actions/checkout@v6
        with: {ref: main}
      - name: Retrieve dbt packages
        uses: actions/download-artifact@v4
        with: *dbt-packages
      - name: Generate production artifacts
        run: >
          dbt parse
          --profile integration_tests
          --target prod
          --target-path prod-artifacts/
      - name: Store production artifacts
        uses: actions/upload-artifact@v4
        with: &prod-artifacts
          name: prod-artifacts
          path: prod-artifacts/

      # Run slim CI
      - name: Checkout feature branch
        uses: actions/checkout@v6
      - name: Retrieve development artifacts
        uses: actions/download-artifact@v4
        with: *dev-artifacts
      - name: Retrieve production artifacts
        uses: actions/download-artifact@v4
        with: *prod-artifacts
      - name: Retrieve dbt packages
        uses: actions/download-artifact@v4
        with: *dbt-packages
      - name: List modified models
        run: >
          dbt list
          --resource-type model
          --select state:modified+
          --state prod-artifacts/
          --profile integration_tests
          --target ci
      - name: Initialise Elementary
        run: >
          dbt run
          --select elementary
          --profile integration_tests
          --target ci
      - name: dbt build (full refresh)
        run: >
          dbt build
          --select state:modified+
          --defer --state prod-artifacts/ --favor-state
          --indirect-selection cautious
          --profile integration_tests
          --target ci
          --full-refresh
      - name: dbt build (incremental)
        run: >
          dbt build
          --select state:modified+
          --defer --state prod-artifacts/ --favor-state
          --indirect-selection cautious
          --profile integration_tests
          --target ci
