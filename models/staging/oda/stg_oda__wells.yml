version: 2

models:
  - name: stg_oda__wells
    description: "Staged wells data from ODA system"
    config:
      elementary:
        timestamp_column: _fivetran_synced
    
    # Elementary model-level tests
    tests:
      - elementary.volume_anomalies:
          tags: ["staging", "oda"]
          anomaly_sensitivity: 3
          fail_on_zero: true

      - elementary.all_columns_anomalies:
          tags: ["staging", "oda"]
          exclude_regexp: ".*_date$|.*_synced$"
          column_anomalies:
            - null_count
            - null_percent

      - elementary.dimension_anomalies:
          tags: ["staging", "oda"]
          dimensions: 
            - "well_status"
            - "well_type"
            - "is_active"
          anomaly_sensitivity: 3

    columns:
      - name: well_id
        description: "Primary identifier for wells"
        tests:
          - unique
          - not_null
          - elementary.column_anomalies:
              tags: ["staging", "oda"]
              column_anomalies:
                - null_count
                - unique_count

      - name: well_name
        description: "Name of the well"
        tests:
          - not_null
          - elementary.column_anomalies:
              tags: ["staging", "oda"]
              column_anomalies:
                - missing_count
                - min_length
                - max_length

      - name: api_number
        description: "API number for the well"
        tests:
          - unique
          - not_null
          - dbt_expectations.expect_column_value_lengths_to_be_between:
              min_value: 10
              max_value: 14

      - name: well_status
        description: "Current status of the well"
        tests:
          - not_null
          - accepted_values:
              values: ['ACTIVE', 'INACTIVE', 'ABANDONED', 'PROPOSED']  # adjust values as needed

      - name: well_type
        description: "Type of well"
        tests:
          - not_null

      - name: latitude
        description: "Well latitude coordinate"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: -90
              max_value: 90

      - name: longitude
        description: "Well longitude coordinate"
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: -180
              max_value: 180

      - name: operator_id
        description: "Foreign key to operators"
        tests:
          - not_null
          - relationships:
              to: ref('stg_oda__operators')
              field: operator_id

      - name: field_id
        description: "Foreign key to fields"
        tests:
          - relationships:
              to: ref('stg_oda__fields')
              field: field_id

      - name: is_active
        description: "Flag indicating if well is active"
        tests:
          - accepted_values:
              values: [true, false]

      - name: create_date
        description: "Date when the well record was created"
        tests:
          - not_null
          - dbt_utils.date_before:
              field: update_date

      - name: update_date
        description: "Date when the well record was last updated"
        tests:
          - not_null
          - elementary.freshness_anomalies:
              tags: ["staging", "oda"]
              freshness_threshold: 24  # hours
              anomaly_sensitivity: 3

      - name: is_deleted
        description: "Fivetran soft delete flag"
        tests:
          - accepted_values:
              values: [true, false]

      - name: _fivetran_synced
        description: "Timestamp of last Fivetran sync"
        tests:
          - not_null
          - elementary.event_freshness_anomalies:
              tags: ["staging", "oda"]
              event_timestamp_column: create_date
              update_timestamp_column: update_date
              anomaly_sensitivity: 3