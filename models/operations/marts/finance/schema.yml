version: 2

models:
  - name: fct_ar_aging_detail
    description: >
      Transaction-level AR aging fact. One row per AR transaction (invoice, payment,
      adjustment, or netting). Replaces fct_ar_aging (retired 2026-02-18).

      Includes is_invoice_posted and is_voucher_posted flags enabling pre-JIB
      analysis (unposted invoices) alongside standard posted AR aging. The parent
      invoice's remaining_balance and include_record are repeated on every
      transaction row for consumer convenience — no additional join needed.

      Use cases:
      - Drill-down to individual transactions for an invoice
      - Pre-JIB preview: WHERE is_invoice_posted = false
      - Posted AR aging: WHERE is_invoice_posted = true AND include_record = 1
    columns:
      - name: invoice_id
        description: FK to stg_oda__arinvoice_v2 — identifies the parent invoice
        data_tests:
          - not_null
      - name: transaction_source
        description: "One of: invoice, payment, adjustment, netting"
        data_tests:
          - not_null
      - name: is_invoice_posted
        description: True when the parent invoice is posted in ODA
        data_tests:
          - not_null
      - name: is_voucher_posted
        description: True when the voucher for this specific transaction is posted
      - name: include_record
        description: >
          1 when remaining_balance != 0 AND exclude_pair = 0. Filter on this for
          actionable outstanding AR transactions.
        data_tests:
          - not_null
      - name: remaining_balance
        description: Total remaining balance on the parent invoice (all transactions, posted and unposted)
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: remaining_balance_posted
        description: >
          Balance comprising only posted invoice amount and posted transaction components.
          NOTE: remaining_balance_posted + remaining_balance_unposted does NOT equal
          remaining_balance when transactions span posted/unposted boundaries (e.g. a
          payment applied to a posted invoice before it posts). These are independent
          views, not a partition of remaining_balance.
      - name: remaining_balance_unposted
        description: >
          Balance comprising only unposted invoice amount and unposted transaction components.
          See remaining_balance_posted for important note about additivity.
      - name: exclude_pair
        description: "1 when the parent invoice is part of an advance/closeout pair"
      - name: balance_due
        description: Transaction amount (positive for invoices, negative for payments/netting)

  - name: fct_ar_aging_summary
    description: >
      Invoice-level AR aging summary with standard aging bucket columns.
      One row per invoice. Replaces fct_ar_aging (retired 2026-02-18).

      Aging bucket definition (based on DATEDIFF(day, invoice_date, CURRENT_DATE())):
      - current_balance: <= 0 days (future-dated or today)
      - balance_1_30_days: 1-30 days past due
      - balance_31_60_days: 31-60 days past due
      - balance_61_90_days: 61-90 days past due
      - balance_90_plus_days: > 90 days past due

      Pre-JIB unposted invoices with future billing dates land in current_balance.
      This is intentional — they represent upcoming billing.

      Use cases:
      - Standard AR aging report: WHERE include_record = 1
      - Posted-only aging: WHERE is_invoice_posted = true AND include_record = 1
      - Pre-JIB treasury preview: WHERE is_invoice_posted = false
    data_tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "remaining_balance is not null"
          config:
            severity: error
            error_msg: >
              Every invoice must have a remaining_balance. NULL indicates a missing
              row in int_oda_ar_invoice_remaining_balances — investigate join integrity.
    columns:
      - name: invoice_id
        description: PK — unique per invoice
        data_tests:
          - unique
          - not_null
      - name: is_invoice_posted
        description: True when the invoice is posted in ODA
        data_tests:
          - not_null
      - name: is_voucher_posted
        description: True when the invoice's voucher is posted
      - name: remaining_balance
        description: >
          Invoice amount + payments + adjustments + netting (additive formula,
          E2E validated against Snowflake data). Negative = credit balance.
        data_tests:
          - not_null
      - name: remaining_balance_posted
        description: >
          Balance comprising only posted invoice amount and posted transaction components.
          Does NOT partition remaining_balance — cross-posted transactions make the two
          split columns non-additive. Use as an independent view, not a decomposition.
      - name: remaining_balance_unposted
        description: >
          Balance comprising only unposted invoice amount and unposted transaction components.
          See remaining_balance_posted for important note about additivity.
      - name: include_record
        description: >
          1 when remaining_balance != 0 AND exclude_pair = 0.
          Bucket columns (current_balance, balance_1_30_days, etc.) populate for ALL invoices
          regardless of this flag. Always filter WHERE include_record = 1 before summing buckets.
        data_tests:
          - not_null
      - name: exclude_pair
        description: "1 when invoice is part of an advance/closeout pair (excluded from aging)"
      - name: days_past_due
        description: DATEDIFF(day, invoice_date, CURRENT_DATE()). Negative for future-dated invoices.
      - name: current_balance
        description: Balance for invoices not yet past due (days_past_due <= 0)
      - name: balance_1_30_days
        description: Balance for invoices 1-30 days past due (BETWEEN 1 AND 30, inclusive)
      - name: balance_31_60_days
        description: Balance for invoices 31-60 days past due
      - name: balance_61_90_days
        description: Balance for invoices 61-90 days past due
      - name: balance_90_plus_days
        description: Balance for invoices more than 90 days past due (> 90, no upper bound)

  - name: fct_gl_details
    description: >
      Canonical GL fact table. Enriches int_gl_enhanced with account classifications
      from dim_accounts. Single source of truth for all GL consumers.

      Grain: one row per GL entry (gl_id). ~180M rows.
      Incremental: merge on gl_id, _flow_published_at watermark.
      Clustered by company_code, journal_date, main_account, sub_account.

      Consumers:
      - fct_los (LOS-filtered subset, posted only)
      - fct_eng_GL (Power BI engineering view, 3-year rolling)
      - Future: any model needing GL + account classification
    columns:
      - name: gl_id
        description: Natural key — ODA GL entry ID
        data_tests:
          - unique
          - not_null
      - name: _flow_published_at
        description: Estuary CDC batch timestamp. Incremental watermark column.
        data_tests:
          - not_null
      - name: company_code
        description: ODA company code (cluster key)
      - name: account_id
        description: FK to dim_accounts.account_id
      - name: main_account
        description: Chart of accounts main account number (cluster key)
      - name: sub_account
        description: Chart of accounts sub account number (cluster key)
      - name: is_los_account
        description: True when account is mapped in the LOS account mapping (from dim_accounts)
      - name: los_category
        description: "High-level LOS grouping: Revenue, Lease Operating Expenses, Capital Expenses, G&A, etc."
      - name: los_section
        description: Detail section within los_category (direct from SharePoint report header)
      - name: is_posted
        description: True when the GL entry has been posted (boolean)
      - name: journal_date
        description: Primary reporting date for the GL entry (cluster key)
      - name: gross_amount
        description: Gross financial value of the GL entry
      - name: net_amount
        description: Net financial value of the GL entry
      - name: well_id
        description: FK to ODA well (nullable — not all GL entries are well-level)
      - name: total_interest_expected
        description: Expected total interest from revenue deck revision (NRI expected)
      - name: net_revenue_interest_actual
        description: Actual net revenue interest from revenue deck revision (NRI actual)

  - name: dim_wells
    description: >
      Well dimension for LOS reporting and Cortex Analyst. One row per ODA well.

      ⚠️  This is a VIEW over well_360 (converted 2026-02-19). Do not alter column names —
      the Cortex Analyst LOS semantic model (LOS_SEMANTIC_MODEL-2.yaml) joins on WELL_ID
      and references many columns from this view.

      Grain: one row per well with an ODA numeric ID (oda_well_id IS NOT NULL in well_360).
      Join key for Cortex: FCT_LOS.WELL_ID = DIM_WELLS.WELL_ID (ODA internal numeric ID).
    columns:
      - name: well_id
        description: ODA internal numeric well ID. Primary key for Cortex Analyst joins (maps to oda_well_id in well_360).
        data_tests:
          - unique
          - not_null
      - name: well_code
        description: ODA cost center code (maps to cost_center_number in well_360).
      - name: well_name
        description: Golden well name from well_360.
      - name: api_number
        description: API-10 identifier (maps to api_10 in well_360).
      - name: basin_name
        description: Formentera operational basin classification (Permian Basin, Eagle Ford, SCOOP/STACK, etc.).
      - name: state_name
        description: Standardized 2-char state abbreviation (maps to state in well_360).
      - name: county_name
        description: Standardized county name in InitCap format (maps to county in well_360).
      - name: op_ref
        description: Standardized operated status string (OPERATED, NON-OPERATED, CONTRACT OPERATED, NON-WELL, etc.).
      - name: is_operated
        description: True when Formentera operates this well.
      - name: is_revenue_generating
        description: True when well is actively producing revenue (not held or suspended).
      - name: is_stripper_well
        description: True when ODA classifies as a stripper well.
      - name: is_well
        description: True when cost_center_type_name = 'Well' (excludes facilities and non-well cost centers).
      - name: activity_status
        description: "Human-friendly well status: Producing, Shut In, Plugged & Abandoned, Temporarily Abandoned, Planned, Injector, Sold, Other."
      - name: well_type
        description: Well type from name patterns (Horizontal, SWD, Injector, Unit Well, Vertical/Conventional, Other). Maps to well_type_oda in well_360.
      - name: search_key
        description: UF-SEARCH KEY userfield — used as GL reporting cross-reference key.
      - name: pv_field
        description: UF-PV FIELD userfield — ProdView field classification.
      - name: operating_group_name
        description: ODA operating group name for regional reporting.
      - name: cost_center_type_name
        description: ODA cost center type name (always 'Well' for rows in this view).
      - name: spud_date
        description: Spud date from well_360 (WellView or Enverus).
      - name: first_production_date
        description: Earliest first production date from well_360.
      - name: shut_in_date
        description: Date well was shut in per ODA.
      - name: inactive_date
        description: Date well became inactive per ODA.
      - name: _refreshed_at
        description: Timestamp when this row was generated (current_timestamp() at query time — this is a view).

  - name: fct_deck_interest_history
    description: >
      Unified deck interest history covering both revenue and expense deck participants.
      One row per deck participant with a deck_type discriminator ('revenue' or 'expense').

      Revenue participants carry product_id (from deck_set); expense rows have NULL product_id
      since expense deck sets have no product column.

      Join chain (4-hop): participant → revision → deck_v2 → deck_set (well_id, effective_date).
      Revenue: 99.9% resolve to well_id. Expense: 100% resolve.

      Enriched with dim_owners (owner_name, owner_code), dim_wells (well_code, eid),
      and stg_oda__interest_type (interest_type_code, interest_type_name).

      Use cases:
      - Full history of ownership interest changes per well
      - Source for bridge_well_owner (current ownership snapshot)
      - Sprint 2: refactor dim_company_WI/NRI to source from this fact
    columns:
      - name: deck_interest_history_sk
        description: Surrogate key on (participant_id, deck_type)
        data_tests:
          - unique
          - not_null
      - name: participant_id
        description: Natural key from the source participant table
        data_tests:
          - not_null
      - name: deck_type
        description: "'revenue' or 'expense' — discriminator for the UNION"
        data_tests:
          - not_null
      - name: well_id
        description: FK to dim_wells — resolved via 4-hop join chain through deck hierarchy
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: owner_id
        description: FK to dim_owners — the interest holder (97.4% populated on expense, 100% on revenue)
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: interest_type_id
        description: "FK to stg_oda__interest_type (T=Total, W=Working, R=Royalty, O=Override, S=Same)"
        data_tests:
          - not_null
      - name: decimal_interest
        description: Ownership interest as a decimal (e.g. 0.125 = 12.5%)
      - name: effective_date
        description: Date this deck version became effective (from deck_v2 header)
      - name: deck_code
        description: Deck set code identifier
      - name: product_id
        description: Product identifier from revenue deck_set (Oil, Gas, NGL, etc.). NULL for expense rows.

  - name: bridge_well_owner
    description: >
      Current ownership interest bridge (M:N) between wells and owners. One row per
      well × owner × deck_type × interest_type combination, filtered to the latest
      effective date and highest revision number.

      Excludes memo-only participants (is_memo = true).

      Use cases:
      - "Who has interest in this well?" lookups
      - Current WI/NRI analysis per well
      - Owner portfolio queries
    columns:
      - name: well_owner_sk
        description: Surrogate key on (well_id, owner_id, deck_type, interest_type_id)
        data_tests:
          - unique
          - not_null
      - name: well_id
        description: FK to dim_wells
        data_tests:
          - not_null
      - name: owner_id
        description: FK to dim_owners
        data_tests:
          - not_null
      - name: deck_type
        description: "'revenue' or 'expense'"
        data_tests:
          - not_null
      - name: interest_type_code
        description: "Interest type code (W=Working, R=Royalty, O=Override, T=Total, S=Same)"
      - name: decimal_interest
        description: Current ownership interest as a decimal
      - name: effective_date
        description: Effective date of the current deck version

  - name: fct_jib_billing
    description: >
      Enriched JIB detail line items. One row per JIB detail entry from stg_oda__jibdetail,
      enriched with account classifications, well/owner/company/AFE names from dimension tables.

      CRITICAL: JIB and JIBDetail have NO direct FK relationship (parallel CDC views). This model
      uses JIBDetail as the sole source — investigation confirmed ZERO DETAILID values match JIB.ID.

      Grain: one row per JIB detail line item (jibdetail.id). ~63M rows.
      Clustered by well_id, owner_id, accrual_date.

      Use cases:
      - JIB billing analysis and reconciliation
      - Owner billing statements
      - Cost allocation reporting by well/AFE/account
    columns:
      - name: jib_billing_sk
        description: Surrogate key on jibdetail.id
        data_tests:
          - unique
          - not_null
      - name: id
        description: Natural key — JIB detail line item ID from ODA
        data_tests:
          - not_null
      - name: well_id
        description: FK to dim_wells — well charged for this billing line
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: owner_id
        description: FK to dim_owners — owner billed
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: account_id
        description: FK to dim_accounts — GL account for classification
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: company_id
        description: FK to dim_companies
      - name: afe_id
        description: FK to dim_afes — AFE associated with this billing line (nullable)
      - name: accrual_date
        description: Accrual date for the billing line
      - name: gross_value
        description: Gross dollar amount for this billing line
      - name: net_value
        description: Net dollar amount (after deck interest)
      - name: expense_deck_interest
        description: Expense deck interest percentage applied
      - name: los_category
        description: LOS category from dim_accounts enrichment

  - name: fct_ap_payment_activity
    description: >
      Invoice-level AP fact with aggregated check payment allocations. One row per AP invoice
      enriched with payment totals, check counts, and derived status fields.

      Check allocation coverage: 97.1% of invoices have at least one check allocation.
      Invoices without allocations show zero for all check aggregate columns.

      Grain: one row per AP invoice. ~336K rows.

      Use cases:
      - AP payment tracking and aging
      - Vendor spend analysis
      - Days-to-payment reporting
      - Overdue invoice identification
    columns:
      - name: ap_payment_activity_sk
        description: Surrogate key on apinvoice.id
        data_tests:
          - unique
          - not_null
      - name: invoice_id
        description: Natural key — AP invoice ID from ODA
        data_tests:
          - unique
          - not_null
      - name: vendor_id
        description: FK to dim_vendors
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: company_id
        description: FK to dim_companies
      - name: invoice_amount
        description: Original invoice amount
      - name: total_check_paid_amount
        description: Sum of all check payment allocations for this invoice
      - name: amount_remaining
        description: "invoice_amount - total_check_paid_amount - total_check_discount_amount"
      - name: check_count
        description: Number of distinct checks applied to this invoice
      - name: is_fully_paid
        description: True when amount_remaining <= 0
      - name: is_overdue
        description: True when due_date < today AND amount_remaining > 0
      - name: is_posted
        description: True when invoice is posted in ODA
      - name: days_to_first_payment
        description: Days between invoice_date and first non-voided check date (NULL if no checks)

  - name: fct_revenue_distribution
    description: >
      Enriched owner revenue distribution line items. One row per owner revenue detail
      record from ODA, enriched with dimension lookups for owners, wells, products,
      purchasers, companies, interest types, payment status, and suspense categories.

      Grain: one row per owner_revenue_detail_v2 record (id). ~61M rows.
      Incremental: merge on id, _flow_published_at watermark.
      Clustered by well_id, production_date, owner_id.

      Use cases:
      - Revenue distribution reporting by owner, well, and product
      - Payment status tracking and suspense analysis
      - Purchaser revenue allocation
      - Revenue reconciliation with check detail
    columns:
      - name: revenue_distribution_sk
        description: Surrogate key on owner_revenue_detail_v2.id
        data_tests:
          - unique
          - not_null
      - name: id
        description: Natural key — ODA owner revenue detail ID
        data_tests:
          - not_null
      - name: owner_id
        description: FK to dim_owners — the interest holder receiving revenue
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: well_id
        description: FK to dim_wells — well producing the revenue
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: company_id
        description: FK to dim_companies — operating company
      - name: product_id
        description: FK to stg_oda__product — commodity type (oil, gas, NGL, etc.)
      - name: production_date
        description: Production period date for this revenue line
        data_tests:
          - not_null:
              config:
                severity: warn
      - name: net_value
        description: Net dollar value of the revenue distribution
      - name: net_volume
        description: Net volume of the commodity
      - name: decimal_interest
        description: Ownership interest decimal applied to this distribution
      - name: payment_status_id
        description: FK to stg_oda__revenue_payment_status (integer ID, not UUID)
      - name: payment_status_name
        description: Human-readable payment status from lookup
      - name: suspense_category_id
        description: FK to stg_oda__revenue_suspense_category
      - name: suspense_category_name
        description: Human-readable suspense category from lookup
      - name: eid
        description: Enterprise ID from well_360 (for cross-system well matching)
      - name: _flow_published_at
        description: Estuary batch timestamp — incremental watermark column
        data_tests:
          - not_null

  - name: wells
    description: Unified wells data combining project wells and company wells.
    columns:
      - name: well_id
        description: Unique identifier for the well.
        data_tests:
          - unique
          - not_null
